<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEON ABYSS // Browser FPS</title>
  <style>
    body { margin:0; overflow:hidden; background:#000; font-family: 'Courier New', monospace; }
    canvas { display:block; }
    #ui { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; color:#0ff; }
    #crosshair { position:absolute; top:50%; left:50%; width:20px; height:20px; margin:-10px 0 0 -10px; }
    #crosshair::before, #crosshair::after { content:''; position:absolute; background:#0ff; opacity:0.8; }
    #crosshair::before { width:2px; height:20px; left:9px; }
    #crosshair::after { width:20px; height:2px; top:9px; }
    #hud { position:absolute; bottom:20px; left:20px; font-size:18px; text-shadow:0 0 10px #0ff; }
    #menu, #pause { position:absolute; inset:0; background:rgba(0,0,20,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; color:#0ff; font-size:48px; text-align:center; transition:opacity 0.5s; }
    #menu h1 { font-size:80px; margin:0; text-shadow:0 0 20px #0ff; animation:glow 2s infinite alternate; }
    button { margin-top:30px; padding:15px 40px; font-size:28px; background:transparent; border:3px solid #0ff; color:#0ff; cursor:pointer; text-shadow:0 0 10px #0ff; box-shadow:0 0 20px #0ff; transition:0.3s; }
    button:hover { background:#0ff; color:#000; }
    @keyframes glow { from { text-shadow:0 0 20px #0ff; } to { text-shadow:0 0 40px #0ff, 0 0 60px #0ff; } }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div id="ui">
    <div id="crosshair"></div>
    <div id="hud">SCORE: <span id="score">0</span> | HEALTH: <span id="health">100</span> | AMMO: <span id="ammo">30</span>/<span id="totalAmmo">90</span></div>
    <div id="menu">
      <h1>NEON ABYSS</h1>
      <p style="font-size:24px;margin:20px;">A cyberpunk arena shooter running 100% in your browser</p>
      <button onclick="startGame()">START MISSION</button>
      <p style="position:absolute;bottom:20px;font-size:14px;">WASD + Mouse • R Reload • ESC Pause • Made with Three.js</p>
    </div>
    <div id="pause" class="hidden">
      <h1>PAUSED</h1>
      <button onclick="togglePause()">RESUME</button><br>
      <button onclick="location.reload()">QUIT</button>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/loaders/GLTFLoader.js';
    import { PointerLockControls } from 'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/controls/PointerLockControls.js';
    import { EffectComposer } from 'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/EffectComposer.js';
    import { RenderPass } from 'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/UnrealBloomPass.js';
    import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js';

    // ──────────────────────────────────────────────────────
    // Scene Setup
    // ──────────────────────────────────────────────────────
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000020, 0.0008);

    const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    document.body.appendChild(renderer.domElement);

    // Post-processing (the "wow" factor)
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 1.4, 0.4, 0.85);
    composer.addPass(bloom);

    // Lights
    const ambient = new THREE.AmbientLight(0x4040ff, 0.4);
    scene.add(ambient);
    const neonPink = new THREE.PointLight(0xff00ff, 2, 50);
    neonPink.position.set(0, 10, 0);
    scene.add(neonPink);
    const neonCyan = new THREE.PointLight(0x00ffff, 2, 50);
    neonCyan.position.set(15, 10, -15);
    scene.add(neonCyan);

    // Controls
    const controls = new PointerLockControls(camera, document.body);
    scene.add(controls.getObject());

    document.getElementById('menu').addEventListener('click', () => controls.lock());
    controls.addEventListener('lock', () => document.getElementById('menu').classList.add('hidden'));
    controls.addEventListener('unlock', () => { if (gameRunning) togglePause(true); });

    // Physics
    const world = new CANNON.World();
    world.gravity.set(0, -20, 0);
    world.broadphase = new CANNON.NaiveBroadphase();

    // Player physics
    const playerShape = new CANNON.Box(new CANNON.Vec3(0.5, 1, 0.5));
    const playerBody = new CANNON.Body({ mass: 80, shape: playerShape });
    playerBody.position.set(0, 5, 0);
    world.addBody(playerBody);

    // Ground
    const groundGeo = new THREE.PlaneGeometry(200, 200);
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x001122, metalness: 0.8, roughness: 0.2 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    const groundPhys = new CANNON.Body({ mass: 0 });
    groundPhys.addShape(new CANNON.Plane());
    groundPhys.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
    world.addBody(groundPhys);

    // ──────────────────────────────────────────────────────
    // Game State
    // ──────────────────────────────────────────────────────
    let gameRunning = false;
    let score = 0;
    let health = 100;
    let ammo = 30;
    let totalAmmo = 90;
    let enemies = [];
    let bullets = [];

    const scoreEl = document.getElementById('score');
    const healthEl = document.getElementById('health');
    const ammoEl = document.getElementById('ammo');
    const totalAmmoEl = document.getElementById('totalAmmo');

    // ──────────────────────────────────────────────────────
    // Audio
    // ──────────────────────────────────────────────────────
    const listener = new THREE.AudioListener();
    camera.add(listener);

    const sounds = {};
    const audioLoader = new THREE.AudioLoader();
    function loadSound(name, url, volume = 0.5) {
      const sound = new THREE.Audio(listener);
      audioLoader.load(url, buffer => {
        sound.setBuffer(buffer);
        sound.setVolume(volume);
        sounds[name] = sound;
      });
    }

    loadSound('shoot', 'https://freesound.org/data/previews/276/276198_5123854-lq.mp3', 0.3);
    loadSound('hit', 'https://freesound.org/data/previews/342/342130_5123854-lq.mp3', 0.4);
    loadSound('reload', 'https://freesound.org/data/previews/387/387178_5123854-lq.mp3', 0.6);
    loadSound('enemyDie', 'https://freesound.org/data/previews/321/321552_3248244-lq.mp3', 0.5);
    loadSound('bgm', 'https://cdn.freesound.org/previews/663/663462_15171407-lq.mp3', 0.15);

    // Background music (loop)
    setTimeout(() => {
      if (sounds.bgm) {
        sounds.bgm.setLoop(true);
        sounds.bgm.play();
      }
    }, 1000);

    // ──────────────────────────────────────────────────────
    // Weapon & Shooting
    // ──────────────────────────────────────────────────────
    const raycaster = new THREE.Raycaster();
    let canShoot = true;

    function shoot() {
      if (!canShoot || ammo <= 0 || !gameRunning) return;
      ammo--;
      ammoEl.textContent = ammo;
      canShoot = false;
      setTimeout(() => canShoot = true, 120); // Fire rate

      if (sounds.shoot) sounds.shoot.play();

      // Muzzle flash
      const flash = new THREE.PointLight(0xffaa00, 5, 10);
      flash.position.copy(camera.position);
      scene.add(flash);
      setTimeout(() => scene.remove(flash), 50);

      // Bullet physics
      const bulletShape = new CANNON.Sphere(0.05);
      const bulletBody = new CANNON.Body({ mass: 0.1 });
      bulletBody.addShape(bulletShape);
      const dir = new THREE.Vector3();
      camera.getWorldDirection(dir);
      bulletBody.position.copy(camera.position);
      bulletBody.velocity.set(dir.x * 200, dir.y * 200, dir.z * 200);
      world.addBody(bulletBody);

      // Visual trail
      const trail = new THREE.Mesh(
        new THREE.CylinderGeometry(0.02, 0.02, 3, 8),
        new THREE.MeshBasicMaterial({ color: 0xffff00 })
      );
      trail.rotation.z = Math.PI / 2;
      trail.position.copy(camera.position);
      scene.add(trail);

      bullets.push({ body: bulletBody, mesh: trail, life: 60 });

      // Raycast for instant hit feel
      raycaster.setFromCamera(new THREE.Vector2(), camera);
      const intersects = raycaster.intersectObjects(scene.children, true);
      if (intersects.length > 0 && intersects[0].distance < 100) {
        const hit = intersects[0];
        if (hit.object.userData.enemy) {
          hitEnemy(hit.object.userData.enemy);
        }
      }
    }

    // ──────────────────────────────────────────────────────
    // Enemies (simple drones with neon glow)
    // ──────────────────────────────────────────────────────
    function spawnEnemy() {
      const radius = 20 + Math.random() * 30;
      const angle = Math.random() * Math.PI * 2;
      const x = Math.cos(angle) * radius;
      const z = Math.sin(angle) * radius;

      const geo = new THREE.DodecahedronGeometry(1.5);
      const mat = new THREE.MeshStandardMaterial({ color: 0xff0066, emissive: 0xff0066, emissiveIntensity: 0.8 });
      const enemy = new THREE.Mesh(geo, mat);
      enemy.position.set(x, 5, z);
      enemy.userData = { health: 3, speed: 3 + Math.random() * 2 };
      scene.add(enemy);

      const light = new THREE.PointLight(0xff0066, 2, 20);
      enemy.add(light);

      enemies.push(enemy);
    }

    function hitEnemy(enemy) {
      enemy.userData.health--;
      if (enemy.userData.health <= 0) {
        score += 100;
        scoreEl.textContent = score;
        scene.remove(enemy);
        enemies = enemies.filter(e => e !== enemy);
        if (sounds.enemyDie) sounds.enemyDie.play();

        // Explosion particles
        for (let i = 0; i < 30; i++) {
          const p = new THREE.Mesh(
            new THREE.SphereGeometry(0.2),
            new THREE.MeshBasicMaterial({ color: 0xff0066 })
          );
          p.position.copy(enemy.position);
          const vel = new THREE.Vector3(
            (Math.random() - 0.5) * 20,
            Math.random() * 20,
            (Math.random() - 0.5) * 20
          );
          scene.add(p);
          const animate = () => {
            p.position.add(vel);
            vel.y -= 0.5;
            p.material.opacity -= 0.02;
            if (p.material.opacity > 0) requestAnimationFrame(animate);
            else scene.remove(p);
          };
          animate();
        }
      }
    }

    // ──────────────────────────────────────────────────────
    // Procedural Level (crates, pillars, neon signs)
    // ──────────────────────────────────────────────────────
    function generateLevel() {
      for (let i = 0; i < 40; i++) {
        const size = 2 + Math.random() * 4;
        const crate = new THREE.Mesh(
          new THREE.BoxGeometry(size, size, size),
          new THREE.MeshStandardMaterial({ 
            color: 0x112233, 
            metalness: 0.9, 
            roughness: 0.1,
            emissive: Math.random() > 0.5 ? 0x00ffff : 0xff00ff,
            emissiveIntensity: 0.3
          })
        );
        const angle = Math.random() * Math.PI * 2;
        const dist = 10 + Math.random() * 40;
        crate.position.set(
          Math.cos(angle) * dist,
          size / 2,
          Math.sin(angle) * dist
        );
        crate.rotation.y = Math.random() * Math.PI;
        scene.add(crate);

        // Physics for crates
        const cratePhys = new CANNON.Body({ mass: 20 });
        cratePhys.addShape(new CANNON.Box(new CANNON.Vec3(size/2, size/2, size/2)));
        cratePhys.position.copy(crate.position);
        world.addBody(cratePhys);
      }
    }

    // ──────────────────────────────────────────────────────
    // Game Controls
    // ──────────────────────────────────────────────────────
    const keys = {};
    window.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; if (e.key === 'Escape') togglePause(); });
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
    window.addEventListener('click', shoot);
    window.addEventListener('resize', () => {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
      composer.setSize(innerWidth, innerHeight);
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'r' && gameRunning) {
        if (totalAmmo > 0) {
          const needed = 30 - ammo;
          const reloadAmount = Math.min(needed, totalAmmo);
          ammo += reloadAmount;
          totalAmmo -= reloadAmount;
          ammoEl.textContent = ammo;
          totalAmmoEl.textContent = totalAmmo;
          if (sounds.reload) sounds.reload.play();
        }
      }
    });

    function togglePause(force) {
      if (!gameRunning) return;
      const pauseMenu = document.getElementById('pause');
      if (force === true || pauseMenu.classList.contains('hidden')) {
        pauseMenu.classList.remove('hidden');
        controls.unlock();
      } else {
        pauseMenu.classList.add('hidden');
        controls.lock();
      }
    }

    window.startGame = () => {
      document.getElementById('menu').classList.add('hidden');
      controls.lock();
      gameRunning = true;
      generateLevel();
      setInterval(() => { if (enemies.length < 10 && gameRunning) spawnEnemy(); }, 3000);
    };

    // ──────────────────────────────────────────────────────
    // Game Loop
    // ──────────────────────────────────────────────────────
    const clock = new THREE.Clock();
    let oldTime = 0;

    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      const elapsed = clock.getElapsedTime();

      if (gameRunning) {
        world.step(1/60, delta, 3);

        // Player movement
        const speed = 12;
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        camera.getWorldDirection(direction);
        direction.y = 0;
        direction.normalize();

        const right = new THREE.Vector3().crossVectors(direction, new THREE.Vector3(0,1,0)).normalize();

        if (keys['w']) velocity.add(direction);
        if (keys['s']) velocity.sub(direction);
        if (keys['a']) velocity.sub(right);
        if (keys['d']) velocity.add(right);

        if (velocity.length() > 0) {
          velocity.normalize().multiplyScalar(speed);
          playerBody.velocity.x = velocity.x;
          playerBody.velocity.z = velocity.z;
        } else {
          playerBody.velocity.x *= 0.9;
          playerBody.velocity.z *= 0.9;
        }

        // Sync camera to physics body
        controls.getObject().position.copy(playerBody.position);
        controls.getObject().position.y += 1.6; // eye height

        // Enemy AI
        enemies.forEach(enemy => {
          const dir = new THREE.Vector3();
          dir.subVectors(playerBody.position, enemy.position);
          dir.y = 0;
          dir.normalize();
          enemy.position.x += dir.x * enemy.userData.speed * delta;
          enemy.position.z += dir.z * enemy.userData.speed * delta;
          enemy.rotation.y += delta * 2;
        });

        // Bullets update
        for (let i = bullets.length - 1; i >= 0; i--) {
          const b = bullets[i];
          b.mesh.position.copy(b.body.position);
          b.mesh.lookAt(camera.position);
          b.life--;
          if (b.life <= 0) {
            scene.remove(b.mesh);
            world.removeBody(b.body);
            bullets.splice(i, 1);
          }
        }
      }

      // Neon pulsing
      neonPink.intensity = 2 + Math.sin(elapsed * 3) * 1.5;
      neonCyan.intensity = 2 + Math.sin(elapsed * 2.7) * 1.5;

      composer.render();
    }

    animate();
  </script>
</body>
</html>
