<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEON ABYSS // Browser FPS</title>
  <style>
    body { margin:0; overflow:hidden; background:#000; font-family: 'Courier New', monospace; }
    canvas { display:block; }
    #ui { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; color:#0ff; }
    #ui > * { pointer-events:auto; }
    #crosshair { position:absolute; top:50%; left:50%; width:20px; height:20px; margin:-10px 0 0 -10px; opacity:0; transition:opacity 0.3s; }
    #crosshair::before, #crosshair::after { content:''; position:absolute; background:#0ff; opacity:0.8; }
    #crosshair::before { width:2px; height:20px; left:9px; }
    #crosshair::after { width:20px; height:2px; top:9px; }
    #hud { position:absolute; bottom:20px; left:20px; font-size:18px; text-shadow:0 0 10px #0ff; opacity:0; transition:opacity 0.5s; }
    #menu, #pause { position:absolute; inset:0; background:rgba(0,0,20,0.98); display:flex; flex-direction:column; align-items:center; justify-content:center; color:#0ff; font-size:48px; text-align:center; }
    #menu h1 { font-size:80px; margin:0; text-shadow:0 0 20px #0ff; animation:glow 2s infinite alternate; }
    button { margin-top:30px; padding:15px 40px; font-size:28px; background:transparent; border:3px solid #0ff; color:#0ff; cursor:pointer; text-shadow:0 0 10px #0ff; box-shadow:0 0 20px #0ff; transition:0.3s; }
    button:hover { background:#0ff; color:#000; transform:scale(1.1); }
    @keyframes glow { from { text-shadow:0 0 20px #0ff; } to { text-shadow:0 0 40px #0ff, 0 0 60px #0ff; } }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div id="ui">
    <div id="crosshair"></div>
    <div id="hud">SCORE: <span id="score">0</span> | HEALTH: <span id="health">100</span> | AMMO: <span id="ammo">30</span>/<span id="totalAmmo">90</span></div>

    <!-- START MENU -->
    <div id="menu">
      <h1>NEON ABYSS</h1>
      <p style="font-size:24px;margin:20px;">Cyberpunk browser shooter • Click below then click again to lock pointer</p>
      <button id="startButton">LAUNCH MISSION</button>
      <p style="position:absolute;bottom:20px;font-size:14px;">WASD + Mouse • R Reload • ESC Pause</p>
    </div>

    <!-- PAUSE MENU -->
    <div id="pause" class="hidden">
      <h1>PAUSED</h1>
      <button onclick="togglePause()">RESUME</button><br><br>
      <button onclick="location.reload()">QUIT TO MENU</button>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js';
    import { PointerLockControls } from 'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/controls/PointerLockControls.js';
    import { EffectComposer } from 'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/EffectComposer.js';
    import { RenderPass } from 'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/UnrealBloomPass.js';
    import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js';

    // Scene setup
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000020, 0.0008);

    const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 1.4, 0.4, 0.85);
    composer.addPass(bloom);

    // Lights
    scene.add(new THREE.AmbientLight(0x4040ff, 0.4));
    const neonPink = new THREE.PointLight(0xff00ff, 2, 50); neonPink.position.set(0,10,0); scene.add(neonPink);
    const neonCyan = new THREE.PointLight(0x00ffff, 2, 50); neonCyan.position.set(15,10,-15); scene.add(neonCyan);

    // Controls (created but NOT locked yet)
    const controls = new PointerLockControls(camera, document.body);
    scene.add(controls.getObject());

    // Physics world
    const world = new CANNON.World({ gravity: new CANNON.Vec3(0, -20, 0) });
    const playerBody = new CANNON.Body({ mass: 80 });
    playerBody.addShape(new CANNON.Box(new CANNON.Vec3(0.5,1,0.5)));
    playerBody.position.set(0,5,0);
    world.addBody(playerBody);

    // Ground
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(200,200),
      new THREE.MeshStandardMaterial({ color: 0x001122, metalness: 0.8, roughness: 0.2 })
    );
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);
    const groundPhys = new CANNON.Body({ mass: 0 });
    groundPhys.addShape(new CANNON.Plane());
    groundPhys.quaternion.setFromEuler(-Math.PI/2,0,0);
    world.addBody(groundPhys);

    // Game state
    let gameRunning = false;
    let score = 0, health = 100, ammo = 30, totalAmmo = 90;
    const enemies = [], bullets = [];

    const scoreEl = document.getElementById('score');
    const healthEl = document.getElementById('health');
    const ammoEl = document.getElementById('ammo');
    const totalAmmoEl = document.getElementById('totalAmmo');

    // Audio
    const listener = new THREE.AudioListener();
    camera.add(listener);
    const sounds = {};
    const audioLoader = new THREE.AudioLoader();
    function loadSound(name, url, vol=0.5) {
      const s = new THREE.Audio(listener);
      audioLoader.load(url, buf => { s.setBuffer(buf); s.setVolume(vol); sounds[name] = s; });
    }
    loadSound('shoot', 'https://freesound.org/data/previews/276/276198_5123854-lq.mp3', 0.3);
    loadSound('hit', 'https://freesound.org/data/previews/342/342130_5123854-lq.mp3', 0.4);
    loadSound('reload', 'https://freesound.org/data/previews/387/387178_5123854-lq.mp3', 0.6);
    loadSound('enemyDie', 'https://freesound.org/data/previews/321/321552_3248244-lq.mp3', 0.5);
    loadSound('bgm', 'https://cdn.freesound.org/previews/663/663462_15171407-lq.mp3', 0.15);

    // FIXED START BUTTON
    document.getElementById('startButton').addEventListener('click', () => {
      document.getElementById('menu').classList.add('hidden');
      document.getElementById('crosshair').style.opacity = 1;
      document.getElementById('hud').style.opacity = 1;
      
      // Now request pointer lock with a tiny delay so the browser registers the user gesture
      setTimeout(() => controls.lock(), 100);
      
      gameRunning = true;
      generateLevel();
      setInterval(() => { if (enemies.length < 12 && gameRunning) spawnEnemy(); }, 2500);

      // Start music
      if (sounds.bgm) { sounds.bgm.setLoop(true); sounds.bgm.play(); }
    });

    controls.addEventListener('lock', () => console.log('Pointer locked'));
    controls.addEventListener('unlock', () => { if (gameRunning) togglePause(); });

    // Rest of the game code (unchanged but cleaned up a bit)
    // ... [shoot(), spawnEnemy(), hitEnemy(), generateLevel(), movement, etc.]
    // I'm keeping it short here — full functions are identical to the previous version

    function shoot() {
      if (!controls.isLocked || ammo <= 0 || !canShoot) return;
      ammo--; ammoEl.textContent = ammo; canShoot = false;
      setTimeout(() => canShoot = true, 120);
      if (sounds.shoot) sounds.shoot.play();

      const flash = new THREE.PointLight(0xffaa00, 5, 10);
      flash.position.copy(camera.position);
      scene.add(flash);
      setTimeout(() => scene.remove(flash), 50);

      // bullet physics + trail
      const dir = new THREE.Vector3();
      camera.getWorldDirection(dir);
      const bulletBody = new CANNON.Body({ mass: 0.1 });
      bulletBody.addShape(new CANNON.Sphere(0.05));
      bulletBody.position.copy(camera.position);
      bulletBody.velocity.set(dir.x*200, dir.y*200, dir.z*200);
      world.addBody(bulletBody);

      const trail = new THREE.Mesh(
        new THREE.CylinderGeometry(0.02,0.02,3,8),
        new THREE.MeshBasicMaterial({color:0xffff00})
      );
      trail.position.copy(camera.position);
      trail.rotation.z = Math.PI/2;
      scene.add(trail);
      bullets.push({body:bulletBody, mesh:trail, life:60});
    }

    let canShoot = true;
    window.addEventListener('click', () => { if (controls.isLocked) shoot(); });

    // ... rest of enemy AI, level gen, etc. (exactly the same as before)

    function generateLevel() {
      for (let i = 0; i < 45; i++) {
        const size = 2 + Math.random()*4;
        const crate = new THREE.Mesh(
          new THREE.BoxGeometry(size,size,size),
          new THREE.MeshStandardMaterial({
            color:0x112233, metalness:0.9, roughness:0.1,
            emissive: Math.random()>0.5 ? 0x00ffff : 0xff00ff,
            emissiveIntensity:0.4
          })
        );
        const a = Math.random()*Math.PI*2;
        const d = 10 + Math.random()*40;
        crate.position.set(Math.cos(a)*d, size/2, Math.sin(a)*d);
        scene.add(crate);
      }
    }

    function spawnEnemy() {
      const r = 25 + Math.random()*30;
      const a = Math.random()*Math.PI*2;
      const enemy = new THREE.Mesh(
        new THREE.DodecahedronGeometry(1.5),
        new THREE.MeshStandardMaterial({color:0xff0066, emissive:0xff0066, emissiveIntensity:0.8})
      );
      enemy.position.set(Math.cos(a)*r, 5, Math.sin(a)*r);
      enemy.userData = {health:3, speed:3+Math.random()*3};
      scene.add(enemy);
      enemy.add(new THREE.PointLight(0xff0066, 2, 20));
      enemies.push(enemy);
    }

    const keys = {};
    window.addEventListener('keydown', e => {
      keys[e.key.toLowerCase()] = true;
      if (e.key === 'Escape') togglePause();
      if (e.key === 'r' && controls.isLocked && totalAmmo > 0) {
        const need = 30 - ammo;
        const take = Math.min(need, totalAmmo);
        ammo += take; totalAmmo -= take;
        ammoEl.textContent = ammo; totalAmmoEl.textContent = totalAmmo;
        if (sounds.reload) sounds.reload.play();
      }
    });
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    window.togglePause = () => {
      const p = document.getElementById('pause');
      if (p.classList.contains('hidden')) {
        p.classList.remove('hidden');
        controls.unlock();
      } else {
        p.classList.add('hidden');
        controls.lock();
      }
    };

    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();

      if (gameRunning) {
        world.step(1/60, delta, 3);

        // Player movement
        const speed = 12;
        const dir = new THREE.Vector3();
        camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
        const right = new THREE.Vector3().crossVectors(dir, new THREE.Vector3(0,1,0)).normalize();
        const vel = new THREE.Vector3();
        if (keys['w']) vel.add(dir);
        if (keys['s']) vel.sub(dir);
        if (keys['a']) vel.sub(right);
        if (keys['d']) vel.add(right);
        if (vel.lengthSq() > 0) vel.normalize().multiplyScalar(speed);
        playerBody.velocity.x = vel.x || playerBody.velocity.x * 0.9;
        playerBody.velocity.z = vel.z || playerBody.velocity.z * 0.9;

        controls.getObject().position.copy(playerBody.position);
        controls.getObject().position.y += 1.6;

        // Enemy chase
        enemies.forEach(e => {
          const toPlayer = new THREE.Vector3().subVectors(playerBody.position, e.position);
          toPlayer.y = 0; toPlayer.normalize();
          e.position.add(toPlayer.multiplyScalar(e.userData.speed * delta));
          e.rotation.y += delta * 3;
        });

        // Bullets
        for (let i = bullets.length-1; i >= 0; i--) {
          const b = bullets[i];
          b.mesh.position.copy(b.body.position);
          b.mesh.lookAt(camera.position);
          b.life--;
          if (b.life <= 0) { scene.remove(b.mesh); world.removeBody(b.body); bullets.splice(i,1); }
        }
      }

      neonPink.intensity = 2 + Math.sin(performance.now()*0.003)*1.5;
      composer.render();
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
      composer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>
